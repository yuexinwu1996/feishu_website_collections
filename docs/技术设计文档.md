# é£ä¹¦ç½‘é¡µæ”¶è—åŠ©æ‰‹ - æŠ€æœ¯è®¾è®¡æ–‡æ¡£ (TDD)

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Chrome æ‰©å±•   â”‚â”€â”€â”€â”€â”‚   ä»£ç†æœåŠ¡å™¨     â”‚â”€â”€â”€â”€â”‚   é£ä¹¦ API      â”‚
â”‚   (å‰ç«¯ç•Œé¢)    â”‚    â”‚   (CORSå¤„ç†)    â”‚    â”‚   (æ•°æ®å­˜å‚¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â”‚                       â”‚                       â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ popup   â”‚              â”‚ Express â”‚            â”‚ å¤šç»´è¡¨æ ¼ â”‚
    â”‚options  â”‚              â”‚ Node.js â”‚            â”‚ æ–‡ä»¶å­˜å‚¨ â”‚
    â”‚backgroundâ”‚              â”‚ ä»£ç†è½¬å‘ â”‚            â”‚ APIæœåŠ¡  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰æ‹©
- **å‰ç«¯**: HTML5 + CSS3 + Vanilla JavaScript
- **æ‰©å±•æ¡†æ¶**: Chrome Extension Manifest V3
- **åç«¯ä»£ç†**: Node.js + Express
- **æ•°æ®å­˜å‚¨**: é£ä¹¦å¤šç»´è¡¨æ ¼
- **æ–‡ä»¶å­˜å‚¨**: é£ä¹¦æ–‡ä»¶æœåŠ¡
- **éƒ¨ç½²**: Vercel/Railway (ä»£ç†æœåŠ¡å™¨)

## ğŸ“ é¡¹ç›®ç»“æ„

```
chrome-extension-feishu/
â”œâ”€â”€ manifest.json              # æ‰©å±•æ¸…å•æ–‡ä»¶
â”œâ”€â”€ popup.html                 # å¼¹çª—ç•Œé¢
â”œâ”€â”€ options.html               # é…ç½®é¡µé¢
â”œâ”€â”€ js/                        
â”‚   â”œâ”€â”€ background.js          # åå°æœåŠ¡å·¥ä½œè€…
â”‚   â”œâ”€â”€ popup.js               # å¼¹çª—é€»è¾‘
â”‚   â””â”€â”€ options.js             # é…ç½®é¡µé¢é€»è¾‘
â”œâ”€â”€ css/
â”‚   â”œâ”€â”€ popup.css              # å¼¹çª—æ ·å¼
â”‚   â””â”€â”€ options.css            # é…ç½®é¡µé¢æ ·å¼
â”œâ”€â”€ icons/                     # æ‰©å±•å›¾æ ‡
â”‚   â”œâ”€â”€ icon16.png
â”‚   â”œâ”€â”€ icon32.png
â”‚   â”œâ”€â”€ icon48.png
â”‚   â””â”€â”€ icon128.png
â”œâ”€â”€ docs/                      # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ äº§å“è®¾è®¡æ–‡æ¡£.md
â”‚   â”œâ”€â”€ æŠ€æœ¯è®¾è®¡æ–‡æ¡£.md
â”‚   â””â”€â”€ å¯¹è¯å†å²è®°å½•.md
â”œâ”€â”€ README.md                  # é¡¹ç›®è¯´æ˜
â”œâ”€â”€ table-setup.md             # è¡¨æ ¼é…ç½®è¯´æ˜
â”œâ”€â”€ proxy-server-example.js    # ä»£ç†æœåŠ¡å™¨ç¤ºä¾‹
â””â”€â”€ get-token.js               # ä»¤ç‰Œè·å–è„šæœ¬
```

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. Manifesté…ç½® (manifest.json)

```json
{
  "manifest_version": 3,
  "permissions": [
    "storage",        // æœ¬åœ°å­˜å‚¨é…ç½®
    "tabs",          // è·å–æ ‡ç­¾é¡µä¿¡æ¯  
    "scripting",     // æ³¨å…¥è„šæœ¬
    "contextMenus",  // å³é”®èœå•
    "notifications", // ç³»ç»Ÿé€šçŸ¥
    "alarms",        // å®šæ—¶ä»»åŠ¡
    "activeTab"      // æ´»åŠ¨æ ‡ç­¾é¡µ
  ],
  "host_permissions": [
    "https://your-proxy-domain.com/*"  // ä»£ç†æœåŠ¡å™¨æƒé™
  ]
}
```

### 2. åå°æœåŠ¡ (background.js)

#### æ ¸å¿ƒç±»è®¾è®¡
```javascript
class FeishuBookmarkExtension {
  constructor() {
    this.apiConfig = {};      // APIé…ç½®
    this.offlineQueue = [];   // ç¦»çº¿é˜Ÿåˆ—
  }
  
  // æ ¸å¿ƒæ–¹æ³•
  init()                    // åˆå§‹åŒ–
  setupContextMenu()        // å³é”®èœå•
  setupMessageHandlers()    // æ¶ˆæ¯å¤„ç†
  saveToFeishu()           // ä¿å­˜åˆ°é£ä¹¦
  checkDuplicate()         // é‡å¤æ£€æŸ¥
  uploadFiles()            // æ–‡ä»¶ä¸Šä¼ 
  processOfflineQueue()    // ç¦»çº¿é˜Ÿåˆ—å¤„ç†
}
```

#### æ•°æ®æµå¤„ç†
```
ç”¨æˆ·æ“ä½œ â†’ popup.js â†’ 
background.js â†’ æ•°æ®é¢„å¤„ç† â†’ 
APIè°ƒç”¨ â†’ é£ä¹¦æœåŠ¡ â†’ 
ç»“æœåé¦ˆ â†’ ç”¨æˆ·ç•Œé¢
```

### 3. ç”¨æˆ·ç•Œé¢ (popup.js)

#### çŠ¶æ€ç®¡ç†
```javascript
class PopupManager {
  constructor() {
    this.currentTab = null;           // å½“å‰æ ‡ç­¾é¡µ
    this.tags = new Set();            // æ ‡ç­¾é›†åˆ
    this.projects = new Set();        // é¡¹ç›®é›†åˆ  
    this.attachments = [];            // é™„ä»¶åˆ—è¡¨
    this.isDetailedFormVisible = false; // è¯¦ç»†è¡¨å•çŠ¶æ€
  }
}
```

#### äº‹ä»¶å¤„ç†æµç¨‹
```
ç”¨æˆ·è¾“å…¥ â†’ æ•°æ®éªŒè¯ â†’ çŠ¶æ€æ›´æ–° â†’ 
ç•Œé¢æ¸²æŸ“ â†’ æ•°æ®æäº¤ â†’ ç»“æœå¤„ç†
```

### 4. é…ç½®ç®¡ç† (options.js)

#### é…ç½®é¡¹ç»“æ„
```javascript
const apiConfig = {
  proxyUrl: '',             // ä»£ç†æœåŠ¡å™¨åœ°å€
  appId: '',                // é£ä¹¦åº”ç”¨ID
  appSecret: '',            // é£ä¹¦åº”ç”¨å¯†é’¥
  tableId: '',              // å¤šç»´è¡¨æ ¼ID
  tenantAccessToken: ''     // è®¿é—®ä»¤ç‰Œ
};
```

## ğŸ”„ æ•°æ®æµè®¾è®¡

### ä¿å­˜æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant P as Popup
    participant B as Background
    participant S as ä»£ç†æœåŠ¡å™¨
    participant F as é£ä¹¦API
    
    U->>P: ç‚¹å‡»ä¿å­˜
    P->>P: éªŒè¯æ•°æ®
    P->>B: å‘é€ä¿å­˜è¯·æ±‚
    B->>B: å¤„ç†æ–‡ä»¶ä¸Šä¼ 
    B->>S: è°ƒç”¨ä»£ç†API
    S->>F: è½¬å‘åˆ°é£ä¹¦
    F-->>S: è¿”å›ç»“æœ
    S-->>B: è¿”å›ç»“æœ
    B-->>P: è¿”å›çŠ¶æ€
    P-->>U: æ˜¾ç¤ºç»“æœ
```

### ç¦»çº¿å¤„ç†æµç¨‹
```mermaid
flowchart TD
    A[ç”¨æˆ·ä¿å­˜] --> B{ç½‘ç»œæ£€æŸ¥}
    B -->|åœ¨çº¿| C[ç›´æ¥ä¿å­˜]
    B -->|ç¦»çº¿| D[åŠ å…¥ç¦»çº¿é˜Ÿåˆ—]
    D --> E[æœ¬åœ°å­˜å‚¨]
    E --> F[å®šæ—¶æ£€æŸ¥ç½‘ç»œ]
    F --> G{ç½‘ç»œæ¢å¤?}
    G -->|æ˜¯| H[å¤„ç†ç¦»çº¿é˜Ÿåˆ—]
    G -->|å¦| F
    H --> I[æ‰¹é‡åŒæ­¥]
    I --> J[æ¸…ç©ºé˜Ÿåˆ—]
```

## ğŸ—„ï¸ æ•°æ®ç»“æ„è®¾è®¡

### ä¹¦ç­¾æ•°æ®ç»“æ„
```javascript
const bookmarkData = {
  url: 'https://example.com',           // ç½‘é¡µé“¾æ¥
  title: 'é¡µé¢æ ‡é¢˜',                     // ç½‘ç«™æ ‡é¢˜  
  notes: 'ç”¨æˆ·å¤‡æ³¨',                     // å¤‡æ³¨
  tags: ['æ ‡ç­¾1', 'æ ‡ç­¾2'],              // åˆ†ç±»æ ‡ç­¾
  project: ['é¡¹ç›®1'],                   // å…³è”é¡¹ç›®
  attachments: [Fileå¯¹è±¡],              // å…³è”æ–‡ä»¶
  createdTime: '2024-12-01T10:00:00Z',  // åˆ›å»ºæ—¶é—´
  lastUpdated: '2024-12-01T10:00:00Z'   // æœ€åæ›´æ–°æ—¶é—´
};
```

### ç¦»çº¿é˜Ÿåˆ—æ•°æ®ç»“æ„
```javascript
const queueItem = {
  id: '1701429600000',                  // å”¯ä¸€ID
  data: bookmarkData,                   // ä¹¦ç­¾æ•°æ®
  timestamp: 1701429600000,             // æ—¶é—´æˆ³
  retryCount: 0                         // é‡è¯•æ¬¡æ•°
};
```

## ğŸ” å®‰å…¨è®¾è®¡

### APIå®‰å…¨
```javascript
// è®¿é—®ä»¤ç‰Œç®¡ç†
class TokenManager {
  async refreshToken() {
    // è‡ªåŠ¨åˆ·æ–°è¿‡æœŸä»¤ç‰Œ
  }
  
  validateToken() {
    // éªŒè¯ä»¤ç‰Œæœ‰æ•ˆæ€§
  }
}

// APIè°ƒç”¨å®‰å…¨
const secureApiCall = async (endpoint, data) => {
  // è¯·æ±‚ç­¾å
  // å‚æ•°éªŒè¯
  // é”™è¯¯å¤„ç†
};
```

### æ•°æ®éªŒè¯
```javascript
// è¾“å…¥éªŒè¯
const validateInput = (data) => {
  return {
    url: validateUrl(data.url),
    title: sanitizeText(data.title),
    tags: validateTags(data.tags)
  };
};

// XSSé˜²æŠ¤
const escapeHtml = (text) => {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
};
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### 1. åŠ è½½ä¼˜åŒ–
- æ‡’åŠ è½½éå…³é”®ç»„ä»¶
- å›¾ç‰‡å’Œèµ„æºå‹ç¼©
- ä»£ç åˆ†å‰²å’Œåˆå¹¶

### 2. ç¼“å­˜ç­–ç•¥
```javascript
// é…ç½®ç¼“å­˜
const configCache = new Map();

// APIå“åº”ç¼“å­˜
const responseCache = new Map();

// ç¦»çº¿æ•°æ®ç¼“å­˜
const offlineCache = new Map();
```

### 3. å¼‚æ­¥å¤„ç†
```javascript
// å¹¶è¡Œå¤„ç†
const parallelTasks = async (tasks) => {
  return Promise.all(tasks.map(task => task()));
};

// é˜²æŠ–å¤„ç†
const debounce = (func, delay) => {
  let timeoutId;
  return (...args) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func.apply(this, args), delay);
  };
};
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```javascript
// URLè§„èŒƒåŒ–æµ‹è¯•
describe('URL Normalization', () => {
  test('should remove tracking parameters', () => {
    const input = 'https://example.com?utm_source=google';
    const expected = 'https://example.com';
    expect(normalizeUrl(input)).toBe(expected);
  });
});

// æ•°æ®éªŒè¯æµ‹è¯•
describe('Data Validation', () => {
  test('should validate bookmark data', () => {
    const data = { url: 'invalid-url' };
    expect(() => validateBookmark(data)).toThrow();
  });
});
```

### é›†æˆæµ‹è¯•
```javascript
// APIé›†æˆæµ‹è¯•
describe('Feishu API Integration', () => {
  test('should save bookmark successfully', async () => {
    const bookmark = createTestBookmark();
    const result = await saveToFeishu(bookmark);
    expect(result.success).toBe(true);
  });
});
```

### ç«¯åˆ°ç«¯æµ‹è¯•
- Chromeæ‰©å±•åŠ è½½æµ‹è¯•
- ç”¨æˆ·ç•Œé¢äº¤äº’æµ‹è¯•
- æ•°æ®ä¿å­˜å®Œæ•´æµç¨‹æµ‹è¯•

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### é”™è¯¯ç›‘æ§
```javascript
// å…¨å±€é”™è¯¯å¤„ç†
window.addEventListener('error', (event) => {
  console.error('Global Error:', event.error);
  // å‘é€é”™è¯¯æŠ¥å‘Š
});

// APIé”™è¯¯è¿½è¸ª
const trackApiError = (endpoint, error) => {
  console.error(`API Error [${endpoint}]:`, error);
  // è®°å½•é”™è¯¯ç»Ÿè®¡
};
```

### æ€§èƒ½ç›‘æ§
```javascript
// æ€§èƒ½è®¡æ—¶
const performanceTimer = {
  start: (label) => console.time(label),
  end: (label) => console.timeEnd(label)
};

// ä½¿ç”¨ç»Ÿè®¡
const trackUsage = (action, metadata) => {
  console.log(`Usage: ${action}`, metadata);
};
```

## ğŸš€ éƒ¨ç½²æ–¹æ¡ˆ

### ä»£ç†æœåŠ¡å™¨éƒ¨ç½²
```javascript
// Vercel éƒ¨ç½²é…ç½®
// vercel.json
{
  "version": 2,
  "builds": [
    { "src": "proxy-server.js", "use": "@vercel/node" }
  ],
  "routes": [
    { "src": "/(.*)", "dest": "/proxy-server.js" }
  ]
}
```

### Chromeæ‰©å±•å‘å¸ƒ
1. **æœ¬åœ°æµ‹è¯•**
   ```bash
   # åŠ è½½åˆ°Chrome
   chrome://extensions/ â†’ å¼€å‘è€…æ¨¡å¼ â†’ åŠ è½½å·²è§£å‹çš„æ‰©å±•ç¨‹åº
   ```

2. **æ‰“åŒ…å‘å¸ƒ**
   ```bash
   # åˆ›å»ºå‘å¸ƒåŒ…
   zip -r extension.zip * -x "*.git*" "docs/*" "*.md"
   ```

3. **Chromeå•†åº—å‘å¸ƒ**
   - æ³¨å†Œå¼€å‘è€…è´¦å· ($5)
   - ä¸Šä¼ æ‰©å±•åŒ…
   - å¡«å†™å•†åº—ä¿¡æ¯
   - ç­‰å¾…å®¡æ ¸

## ğŸ”„ ç‰ˆæœ¬ç®¡ç†

### ç‰ˆæœ¬å·è§„åˆ™
- ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬ (å¦‚ 1.0.0)
- manifest.json ä¸­çš„ç‰ˆæœ¬å·åŒæ­¥æ›´æ–°
- Gitæ ‡ç­¾ç®¡ç†ç‰ˆæœ¬å‘å¸ƒ

### æ›´æ–°ç­–ç•¥
```javascript
// è‡ªåŠ¨æ›´æ–°æ£€æŸ¥
chrome.runtime.onUpdateAvailable.addListener(() => {
  // æç¤ºç”¨æˆ·æ›´æ–°
  chrome.runtime.reload();
});
```

## ğŸ“š å¼€å‘è§„èŒƒ

### ä»£ç è§„èŒƒ
- ES6+ è¯­æ³•
- ä¸¥æ ¼æ¨¡å¼
- ä¸€è‡´çš„å‘½åçº¦å®š
- è¯¦ç»†çš„æ³¨é‡Šæ–‡æ¡£

### Gitå·¥ä½œæµ
```bash
# åŠŸèƒ½å¼€å‘
git checkout -b feature/new-feature
git commit -m "feat: add new feature"
git push origin feature/new-feature

# ç‰ˆæœ¬å‘å¸ƒ
git checkout main
git tag v1.0.0
git push origin v1.0.0
```

---

**ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025å¹´9æœˆ  
**ç»´æŠ¤è€…**: æŠ€æœ¯å¼€å‘å›¢é˜Ÿ